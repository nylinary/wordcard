{% extends 'core/base.html' %}
{% block title %}Добавить новое слово{% endblock %}

{% block extra_css %}
<style>
    /* Heart icon styles */
    .heart-icon.filled {
        fill: white !important;
    }
    .heart-icon.outlined {
        fill: transparent !important;
        stroke: currentColor;
        stroke-width: 1;
    }
    /* Fix for touch devices */
    .btn-outline-danger:active, 
    .btn-outline-danger:focus {
        background-color: transparent !important;
        color: #dc3545 !important;
    }
    .btn-outline-danger:active .heart-icon.outlined, 
    .btn-outline-danger:focus .heart-icon.outlined {
        fill: transparent !important;
    }
    /* Additional fix for mobile */
    .btn-danger .heart-icon {
        fill: white !important;
    }
    .btn-outline-danger .heart-icon {
        fill: transparent !important;
    }
    /* Prevent hover state on touch */
    @media (hover: none) {
        .btn-outline-danger:hover {
            color: #dc3545;
            background-color: transparent;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="my-2">Добавить новое слово</h2>
            </div>
            <div class="card-body">
                <form id="wordLookupForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ form.word.label_tag }}
                        {{ form.word }}
                    </div>
                    <button type="submit" class="btn btn-primary">Найти</button>
                </form>
                
                <div id="wordResult" class="mt-4" style="display: none;">
                    <div class="card word-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 id="resultWord" class="mb-0"></h3>
                            <button id="saveWordBtn" class="btn btn-outline-danger" title="Сохранить в мою коллекцию">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi heart-icon outlined" viewBox="0 0 16 16">
                                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="resultPartOfSpeech" class="text-muted mb-2"></div>
                            <p id="resultDefinition" class="mb-4"></p>
                            <h5>Примеры:</h5>
                            <ul id="resultExamples"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const wordLookupForm = document.getElementById('wordLookupForm');
    const wordInput = document.querySelector('[name="word"]');
    const wordResult = document.getElementById('wordResult');
    const resultWord = document.getElementById('resultWord');
    const resultPartOfSpeech = document.getElementById('resultPartOfSpeech');
    const resultDefinition = document.getElementById('resultDefinition');
    const resultExamples = document.getElementById('resultExamples');
    const saveWordBtn = document.getElementById('saveWordBtn');
    const heartIcon = saveWordBtn.querySelector('.heart-icon');
    
    let currentWordId = null;
    let isWordSaved = false;
    
    // Initialize the heart icon with outlined class
    heartIcon.classList.add('outlined');
    
    // Set the button state based on whether the word is saved
    function updateSaveButtonState(isSaved) {
        isWordSaved = isSaved;
        
        if (isSaved) {
            // Saved state - filled heart
            saveWordBtn.classList.remove('btn-outline-danger');
            saveWordBtn.classList.add('btn-danger');
            saveWordBtn.title = 'Удалить из коллекции';
            heartIcon.classList.add('filled');
            heartIcon.classList.remove('outlined');
        } else {
            // Unsaved state - outlined heart
            saveWordBtn.classList.remove('btn-danger');
            saveWordBtn.classList.add('btn-outline-danger');
            saveWordBtn.title = 'Сохранить в мою коллекцию';
            heartIcon.classList.remove('filled');
            heartIcon.classList.add('outlined');
        }
        
        saveWordBtn.disabled = false;
    }
    
    wordLookupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(wordLookupForm);
        
        fetch('{% url "words:word_lookup" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Handle redirect case
            
            if (data.error) {
                alert(data.error);
                return;
            }
            
            resultWord.textContent = data.word;
            resultPartOfSpeech.textContent = data.part_of_speech || '';
            resultDefinition.textContent = data.definition;
            
            // Очищаем список примеров
            resultExamples.innerHTML = '';
            
            // Добавляем новые примеры
            if (data.examples && data.examples.length > 0) {
                data.examples.forEach(example => {
                    const li = document.createElement('li');
                    li.textContent = example;
                    resultExamples.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'Примеры не найдены';
                resultExamples.appendChild(li);
            }
            
            // Сохраняем ID слова
            currentWordId = data.id;
            
            // Показываем результат
            wordResult.style.display = 'block';
            
            // Set the initial button state based on whether the word is saved
            updateSaveButtonState(data.is_saved || false);
            
            // Clear input field after successful word lookup
            wordInput.value = '';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при поиске слова.');
        });
    });
    
    // Use touchend for mobile devices to prevent hover state issues
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const clickEvent = isTouchDevice ? 'touchend' : 'click';
    
    saveWordBtn.addEventListener(clickEvent, function(e) {
        if (isTouchDevice) {
            e.preventDefault(); // Prevent default touch behavior
        }
        
        if (!currentWordId) return;
        
        // Check if user is authenticated
        {% if user.is_authenticated %}
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const formData = new FormData();
            formData.append('word_id', currentWordId);
            
            // Disable button right away to prevent double-clicks
            saveWordBtn.disabled = true;
            
            // Choose endpoint based on current state
            const endpoint = isWordSaved ? 
                '{% url "words:remove_word" %}' : 
                '{% url "words:save_word" %}';
            
            fetch(endpoint, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return; // Handle redirect case
                
                if (data.success) {
                    // Toggle the saved state
                    updateSaveButtonState(!isWordSaved);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Re-enable the button if there's an error
                saveWordBtn.disabled = false;
            });
        {% else %}
            // Redirect directly to login page instead of showing modal
            window.location.href = "{% url 'account_login' %}";
        {% endif %}
    });
    
    // Reset button state when clicked on mobile
    if (isTouchDevice) {
        saveWordBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            // Add a visual feedback class that will be removed on touchend
            this.classList.add('touch-active');
        });
        
        saveWordBtn.addEventListener('touchcancel', function() {
            this.classList.remove('touch-active');
        });
    }
});
</script>
{% endblock %}